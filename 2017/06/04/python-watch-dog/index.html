<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="何恩 何恩之有 HenryLuo Henry Luo Blog 生活 项目 编程 henng h3nng"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="http://henng.com/atom.xml" title="HENNG" type="application/atom+xml"><link rel="icon" href="http://henng.com/images/favicon.ico"><title>用 Python 来守护你的程序 - HENNG</title><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">HENNG</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">HOME</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">ARCHIVES</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">ABOUT</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-06-04T14:43:27.000Z" class="post__time">六月 4, 2017</time><h1 class="post__title"><a href="/2017/06/04/python-watch-dog/">用 Python 来守护你的程序</a></h1></header><div class="post__main echo"><p>之前项目里有个程序，含有 HTTP 上传的相关逻辑；长时间跑，偶尔会出现连接超时的异常，然后再也不能进行新的上传。经过多方面的排查，我最终定位到是该程序里使用的第三方 sdk 的问题，该 sdk 中在某种特定场景下没有正确释放连接，导致一段时间后，获取不到任何可用连接，于是有了连接超时的异常。<a id="more"></a></p>
<p>而让人头疼的是，该 sdk 的项目组目前没人维护，基本处于“荒废”的状态。没办法，指望对方修复 bug 是不太现实了，只能自己这边想办法绕过或处理。于是，采用最简单的重启大法，即出现该异常时，重启我的程序即可恢复。之前也提到过，要开始学习下 Python/PHP 这类语言，这次便用 Python 写了个“看门狗”，一个简单的守护任务。逻辑很简单，扫描程序的 log，出现特定异常时，调用该程序的 stop/start 两个 shell 脚本来完成重启逻辑。</p>
<p>不多说，直接上代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># set JAVA_HOME</span></span><br><span class="line">os.environ[<span class="string">"JAVA_HOME"</span>] = <span class="string">"/AAA/BBB/jdk1.6"</span></span><br><span class="line">startShell = <span class="string">'sh /AAA/BBB/my-program/bin/start.sh'</span></span><br><span class="line">stopShell = <span class="string">'sh /AAA/BBB/my-program/bin/stop.sh'</span></span><br><span class="line">filename = <span class="string">'/AAA/BBB/logs/my-program.log'</span></span><br><span class="line"></span><br><span class="line">f = subprocess.Popen([<span class="string">'tail'</span>, <span class="string">'-F'</span>, filename], \</span><br><span class="line">                     stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">p = select.poll()</span><br><span class="line">p.register(f.stdout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">if</span> p.poll(<span class="number">1</span>):</span><br><span class="line">        line = f.stdout.readline()</span><br><span class="line">        errMsg = <span class="string">'Caused by: org.apache.http.conn.ConnectionPoolTimeoutException: '</span> \</span><br><span class="line">                 <span class="string">'Timeout waiting for connection from pool'</span></span><br><span class="line">        <span class="keyword">if</span> errMsg <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">print</span> line</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># before python2.7, there's no 'subprocess.check_output'</span></span><br><span class="line">                stopOutput = subprocess.check_output([<span class="string">'/bin/sh'</span>, <span class="string">'-c'</span>, stopShell])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                stopOutput = subprocess.Popen([<span class="string">'/bin/sh'</span>, <span class="string">'-c'</span>, stopShell], stdout=subprocess.PIPE).communicate()[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'stop finished'</span> <span class="keyword">in</span> stopOutput:</span><br><span class="line">                subprocess.Popen([<span class="string">'/bin/sh'</span>, <span class="string">'-c'</span>, startShell])</span><br></pre></td></tr></table></figure>
<p>逻辑比较简单，但这里我提出几点部署过程中容易踩坑的地方。</p>
<p>第一点，我使用 ansible 批量执行，我的程序是一个 JAVA 程序，而不同主机上环境变量可能有所不同，所以我指定一个统一的 JDK：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.environ[<span class="string">"JAVA_HOME"</span>] = <span class="string">"/AAA/BBB/jdk1.6"</span></span><br></pre></td></tr></table></figure>
<p>第二点，我发现有的 Python 守护任务执行失败了，原因是 <code>subprocess.check_output</code> 这个方法在 Python 2.7 版本之前好像是不支持的，而由于历史等原因，某些主机上的 Python 版本是比较低的，还得使用 Popen：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subprocess.Popen([<span class="string">'/bin/sh'</span>, <span class="string">'-c'</span>, stopShell], stdout=subprocess.PIPE).communicate()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>最后一点，让 Python 守护任务在后台一直跑着，输出必要的日志。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python -u python_watch_dog.py &#62; python_watch_dog.log 2&#62;&#38;1 &#38;</span><br></pre></td></tr></table></figure>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Java/" class="post__tag__link">Java</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/原创/" class="post__tag__link">原创</a></li></ul><a href="/2017/06/04/python-watch-dog/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><div class="comments"><div id="disqus_thread"><script>var disqus_config = function () {
this.page.url = page.permalink;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = page.title; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://henng.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2014-2017 henng<bdi> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with theme <a href="https://github.com/henng/lesss" target="_blank">lesss</a> based on <a href="https://github.com/unmric/hexo-theme-strict" target="_blank">strict</a></bdi></div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"> </span></li><li class="page-menu__item"><a title="Next" href="/2017/04/15/RuntimeException/" class="page-menu__link icon-arrow-right"> </a></li></menu></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-54955970-2', 'auto');
ga('send', 'pageview');
</script></body></html>